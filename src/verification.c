#include <stdint.h>
#include <string.h>
#include <graphx.h>
#undef NDEBUG
#define DEBUG
#include <debug.h>
#include "verification.h"
#include "versions.h"

const uint24_t crc_table[256] = {
        0x0, 0x1d215d, 0x3a42ba, 0x2763e7, 0x748574, 0x69a429, 0x4ec7ce,
        0x53e693, 0xe90ae8, 0xf42bb5, 0xd34852, 0xce690f, 0x9d8f9c, 0x80aec1,
        0xa7cd26, 0xbaec7b, 0xe09eb3, 0xfdbfee, 0xdadc09, 0xc7fd54, 0x941bc7,
        0x893a9a, 0xae597d, 0xb37820, 0x9945b, 0x14b506, 0x33d6e1, 0x2ef7bc,
        0x7d112f, 0x603072, 0x475395, 0x5a72c8, 0xf3b605, 0xee9758, 0xc9f4bf,
        0xd4d5e2, 0x873371, 0x9a122c, 0xbd71cb, 0xa05096, 0x1abced, 0x79db0,
        0x20fe57, 0x3ddf0a, 0x6e3999, 0x7318c4, 0x547b23, 0x495a7e, 0x1328b6,
        0xe09eb, 0x296a0c, 0x344b51, 0x67adc2, 0x7a8c9f, 0x5def78, 0x40ce25,
        0xfa225e, 0xe70303, 0xc060e4, 0xdd41b9, 0x8ea72a, 0x938677, 0xb4e590,
        0xa9c4cd, 0xd5e769, 0xc8c634, 0xefa5d3, 0xf2848e, 0xa1621d, 0xbc4340,
        0x9b20a7, 0x8601fa, 0x3ced81, 0x21ccdc, 0x6af3b, 0x1b8e66, 0x4868f5,
        0x5549a8, 0x722a4f, 0x6f0b12, 0x3579da, 0x285887, 0xf3b60, 0x121a3d,
        0x41fcae, 0x5cddf3, 0x7bbe14, 0x669f49, 0xdc7332, 0xc1526f, 0xe63188,
        0xfb10d5, 0xa8f646, 0xb5d71b, 0x92b4fc, 0x8f95a1, 0x26516c, 0x3b7031,
        0x1c13d6, 0x1328b, 0x52d418, 0x4ff545, 0x6896a2, 0x75b7ff, 0xcf5b84,
        0xd27ad9, 0xf5193e, 0xe83863, 0xbbdef0, 0xa6ffad, 0x819c4a, 0x9cbd17,
        0xc6cfdf, 0xdbee82, 0xfc8d65, 0xe1ac38, 0xb24aab, 0xaf6bf6, 0x880811,
        0x95294c, 0x2fc537, 0x32e46a, 0x15878d, 0x8a6d0, 0x5b4043, 0x46611e,
        0x6102f9, 0x7c23a4, 0x9945b1, 0x8464ec, 0xa3070b, 0xbe2656, 0xedc0c5,
        0xf0e198, 0xd7827f, 0xcaa322, 0x704f59, 0x6d6e04, 0x4a0de3, 0x572cbe,
        0x4ca2d, 0x19eb70, 0x3e8897, 0x23a9ca, 0x79db02, 0x64fa5f, 0x4399b8,
        0x5eb8e5, 0xd5e76, 0x107f2b, 0x371ccc, 0x2a3d91, 0x90d1ea, 0x8df0b7,
        0xaa9350, 0xb7b20d, 0xe4549e, 0xf975c3, 0xde1624, 0xc33779, 0x6af3b4,
        0x77d2e9, 0x50b10e, 0x4d9053, 0x1e76c0, 0x3579d, 0x24347a, 0x391527,
        0x83f95c, 0x9ed801, 0xb9bbe6, 0xa49abb, 0xf77c28, 0xea5d75, 0xcd3e92,
        0xd01fcf, 0x8a6d07, 0x974c5a, 0xb02fbd, 0xad0ee0, 0xfee873, 0xe3c92e,
        0xc4aac9, 0xd98b94, 0x6367ef, 0x7e46b2, 0x592555, 0x440408, 0x17e29b,
        0xac3c6, 0x2da021, 0x30817c, 0x4ca2d8, 0x518385, 0x76e062, 0x6bc13f,
        0x3827ac, 0x2506f1, 0x26516, 0x1f444b, 0xa5a830, 0xb8896d, 0x9fea8a,
        0x82cbd7, 0xd12d44, 0xcc0c19, 0xeb6ffe, 0xf64ea3, 0xac3c6b, 0xb11d36,
        0x967ed1, 0x8b5f8c, 0xd8b91f, 0xc59842, 0xe2fba5, 0xffdaf8, 0x453683,
        0x5817de, 0x7f7439, 0x625564, 0x31b3f7, 0x2c92aa, 0xbf14d, 0x16d010,
        0xbf14dd, 0xa23580, 0x855667, 0x98773a, 0xcb91a9, 0xd6b0f4, 0xf1d313,
        0xecf24e, 0x561e35, 0x4b3f68, 0x6c5c8f, 0x717dd2, 0x229b41, 0x3fba1c,
        0x18d9fb, 0x5f8a6, 0x5f8a6e, 0x42ab33, 0x65c8d4, 0x78e989, 0x2b0f1a,
        0x362e47, 0x114da0, 0xc6cfd, 0xb68086, 0xaba1db, 0x8cc23c, 0x91e361,
        0xc205f2, 0xdf24af, 0xf84748, 0xe56615};

//uint24_t bit_reverse(uint24_t num) {
//    uint24_t reversed = 0;
//    uint8_t i;
//    for (i = 0; i < 24; i++) {
//        if((num & (1 << i)))
//            reversed |= 1 << ((24 - 1) - i);
//    }
//    return reversed;
//}
//
//void crc_gen_table(void) {
//    uint24_t rem;
//    uint24_t i, j;
//    for (i = 0; i < 256; i++) {
//        rem = i;  /* remainder from polynomial division */
//        for (j = 0; j < 8; j++) {
//            if (rem & 1) {
//                rem >>= 1;
//                rem ^= 0x9945b1;
//            } else {
//                rem >>= 1;
//            }
//        }
//        dbg_sprintf(dbgout, "0x%x, ", bit_reverse(rem));
//        //crc_table[i] = rem;
//    }
//}

/* No idea how to generate these on an actual computer */
uint24_t crc24(const uint8_t *buf, size_t len) {
    uint24_t crc = 0;
    const uint8_t *p, *q;

    q = buf + len;
    for (p = buf; p < q; p++) {
        crc = (crc >> 8) ^ crc_table[(crc & 0xff) ^ *p];
    }
    return crc;
}

const uint8_t interrupt_handler[] = {0xF3, 0xED, 0x7E, 0x5B, 0xC3};

bool verify_interrupt_handlers(void) {
    uint8_t i;

    for(i = 0; i <= 0x30; i += 8) {
        if(memcmp(&gfx_vram[i], interrupt_handler, sizeof(interrupt_handler)) != 0) {
            dbg_sprintf(dbgout, "no handler at 0x%X (0x%X)\n", i, gfx_vram[i]);
            return false;
        }
    }

    return true;
}

bool verify_boot_calls(void) {
    uint24_t i;

    for(i = 0x80; i < 0x640; i += 4) {
        if(gfx_vram[i] != 0xC3) {
            dbg_sprintf(dbgout, "no call at 0x%X\n", i);
            return false;
        }
    }

    return true;
}

bool verify_pre_m_version(void) {
    if(version_in_vram->very_major > 5) return false;
    if(version_in_vram->major > 3) return false;
    return true;
}
